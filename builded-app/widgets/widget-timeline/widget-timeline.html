<!-- Timeline Lib http://almende.github.io/chap-links-library/timeline.html -->
<!-- Timeline example http://almende.github.io/chap-links-library/js/timeline/examples/example17_json_data.html -->
<polymer-element name="widget-timeline" attributes="options">
  <template>
    <link rel="stylesheet" type="text/css" href="vendor/timeline-2.6.1/timeline.css">
    <link rel="stylesheet" type="text/css" href="vendor/timeline-2.6.1/timeline-theme.css">
    <snap-widget name="Timeline">
      <div class="edit">
        <button on-click="{{addEvent}}">Add event</button>
        <ul>
          <template repeat="{{e in events}}">
            <li>
              <label>Start <input type="date" value="{{e.start}}" /></label><br />
              <label>End <input type="date" value="{{e.end}}" /></label><br />
              <label>Content <textarea value="{{e.content}}"></textarea></label><br />
            </li>
          </template>
        </ul>
      </div>
      <div class="view">
        <div id="timeline"></div>
      </div>
    </snap-widget>
  </template>
  <script type="text/javascript" src="vendor/timeline-2.6.1/timeline-min.js"></script>
  <script type="text/javascript" src="vendor/timeline-2.6.1/timeline-locales.js"></script>
  <script>
    Polymer('widget-timeline', {

      timelineOpts: {
        height: '300px',
        width: '100%',
        style: 'box',
        locale: 'fr'
      },

      ready: function() {
        this.events = [];
        this.timeline = new links.Timeline(this.$.timeline);
        this.redraw();
        this.addEventListener('showView', this.redraw.bind(this));
      },

      redraw: function() {
        this.async(function() {
          this.rebuildDates();
          console.log(this.events);
          this.timeline.draw(this.events, this.timelineOpts);
        });
      },

      rebuildDates: function() {
        this.events.forEach(function(e) {
          if('start' in e && !(e.start instanceof Date)) {
            e.start = new Date(Date.parse(e.start));
          }
          if('end' in e && !(e.end instanceof Date)) {
            e.end = Date.parse(e.end);
          }
        });
      },

      addEvent: function() {
        this.events.push({
          start: new Date(),
          end: null,
          content: ''
        });
      }

    });
  </script>
</polymer-element>